#include <curl/curl.h>
#include <jsoncpp/json/json.h>
#include <string>
#include <stdio.h>
#include <iostream>
#include <sstream>

Json::Value getSportsNews(std::string sport);
static std::size_t writeFunction(char *ptr, std::size_t size, std::size_t num, char* out);
void displayArticles(Json::Value articles);

int main(int argc, char** argv) {
    std::string sport = "Basketball";
    Json::Value data = getSportsNews(sport);
    displayArticles(data); 
}

void displayArticles(Json::Value articles){
    int size = articles["articles"].size();
    for(int x = 0; x < size; x++){
        std::cout << articles["articles"][x]["title"].asString() << "\n";
        std::cout << "Written by " << articles["articles"][x]["author"].asString() << " from " << articles["articles"][x]["source"]["name"].asString() << "\n";
        std::cout << "Published on " << articles["articles"][x]["publishedAt"].asString() << "\n";
        std::cout << articles["articles"][x]["description"].asString() << "\n";
        std::cout << "\n";
    }
}


Json::Value getSportsNews(std::string sport){
    const std::string APIKEY = "78572ce08bad450c9a68185c8b7fc9c5";
    const std::string URL = "http://newsapi.org/v2/everything?q=" + sport + "&language=en&sortBy=publishedAt&apiKey=" + APIKEY; //url automatically only takes articles from todays date

    CURL* curl = curl_easy_init();
    if (curl) {
        curl_easy_setopt(curl, CURLOPT_URL, URL.c_str());
        curl_easy_setopt(curl, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
        curl_easy_setopt(curl, CURLOPT_TIMEOUT, 10);
        curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
           
        std::stringstream response_string;
        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, writeFunction);
        curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response_string);    //response is written to a response stream, which is sent to the write function

        curl_easy_perform(curl);
        curl_easy_cleanup(curl);
       
        Json::Value data;
        Json::CharReaderBuilder reader;
        std::string errs;
        
        if(Json::parseFromStream(reader, response_string, &data, &errs)){
            return data;
        }
        throw std::string("The data could not be retrieved.");
    } 
}

static std::size_t writeFunction(char *ptr, std::size_t size, std::size_t num, char* out) {
    std::string data (ptr, (std::size_t) size * num); //create a string of the data using ptr (which i believe is a pointer to the response stream)
    *((std::stringstream*) out) << data;
    return size * num;
}



